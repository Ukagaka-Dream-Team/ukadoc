<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="robots" content="INDEX,FOLLOW">
<meta name="author" content="UKADOC Project">
<meta name="keywords" content="ukadoc,伺か">
<title>UKADOC Project SHIORI/3.0</title>
<link rel="stylesheet" href="list.css" />
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
</head>
<body>
	<h1 id="page-title">SHIORI/3.0</h1>
	<nav class="menu-header">
		<table>
			<tbody>
				<tr>
					<th>トップページへ戻る</th>
					<td colspan="2">
						<ul>
							<li><a href="https://ukagakadreamteam.github.io/ukadoc/manual/index.html">INDEX</a></li>
						</ul>
					</td>
				</tr>
			</tbody>
			<tbody>
				<tr>
					<th rowspan="6">設定ファイル</th>
					<th>Ghost</th>
					<td>
						<ul>
							<li><a href="./descript_ghost.html">descript.txt</a></li>
						</ul>
					</td>
				</tr>
				<tr>
					<th>Shell</th>
					<td>
						<ul>
							<li><a href="./descript_shell.html">descript.txt</a></li>
							<li><a href="./descript_shell_surfaces.html">surfaces.txt</a></li>
							<li><a href="./descript_shell_surfacetable.html">surfacetable.txt</a></li>
						</ul>
					</td>
				</tr>
				<tr>
					<th>Balloon</th>
					<td>
						<ul>
							<li><a href="./descript_balloon.html">descript.txt</a></li>
							<li><a href="./descript_balloon.html#balloonsoption">balloon(s/k)*s.txt</a></li>
						</ul>
					</td>
				</tr>
				<tr>
					<th>Plugin</th>
					<td>
						<ul>
							<li><a href="./descript_plugin.html">descript.txt</a></li>
						</ul>
					</td>
				</tr>
				<tr>
					<th>Headline</th>
					<td>
						<ul>
							<li><a href="./descript_headline.html">descript.txt</a></li>
						</ul>
					</td>
				</tr>
				<tr>
					<th>Install</th>
					<td>
						<ul>
							<li><a href="./descript_install.html">install.txt</a></li>
							<li><a href="./descript_install.html#delete.txt">delete.txt</a></li>
							<li><a href="./descript_install.html#developer_options.txt">developer_options.txt</a></li>
						</ul>
					</td>
				</tr>
			</tbody>
			<tbody>
				<tr>
					<th>さくらスクリプト</th>
					<td colspan="2">
						<ul>
							<li><a href="./list_sakura_script.html">Sakura Script</a></li>
							<li><a href="./list_propertysystem.html">Property System</a></li>
						</ul>
					</td>
				</tr>
			</tbody>
			<tbody>
				<tr>
					<th rowspan="2">イベント</th>
					<th>SHIORI</th>
					<td>
						<ul>
							<li><a href="./list_shiori_event.html">SHIORI Event</a></li>
							<li><a href="./list_shiori_event_ex.html">SHIORI Event（外部）</a></li>
							<li><a href="./list_shiori_resource.html">SHIORI Resource</a></li>
						</ul>
					</td>
				</tr>
				<tr>
					<th>PLUGIN</th>
					<td>
						<ul>
							<li><a href="./list_plugin_event.html">PLUGIN Event</a></li>
						</ul>
					</td>
				</tr>
			</tbody>
			<tbody>
				<tr>
					<th>規格</th>
					<td colspan="2">
						<ul>
							<li><a href="./spec_shiori3.html">SHIORI/3.0</a></li>
							<li><a href="./spec_sstp.html">SSTP/1.x</a></li>
							<li><a href="http://www.boreas.dti.ne.jp/~sdn/saori.html">SAORI/1.0</a>（外部サイト）</li>
							<li><a href="./spec_plugin.html">PLUGIN/2.0</a></li>
							<li><a href="./spec_headline.html">HEADLINE/2.0</a></li>
							<li><a href="./spec_dll.html">DLL</a></li>
							<li><a href="./spec_fmo_mutex.html">FMO/MUTEX</a></li>
							<li><a href="./spec_web.html">Web関連</a></li>
						</ul>
					</td>
				</tr>
			</tbody>
		</table>
	</nav>
	<section class="navigation-bar">
		<h1>SHIORI/3.0</h1>
		<section class="navigation-category">
			<h1>SHIORI/3.0</h1>
			<ul>
				<li><a href="#capability">実装対応状況の検知</a></li>
				<li><a href="#request">request</a></li>
				<li><a href="#response">response</a></li>
			</ul>
		</section>
	</section>
	<div class="categories">
		<section class="category caption introduction" id="chapter0">
			<h1>SHIORI/3.0</h1>
			<p>参考：<a href="http://usada.sakura.vg/contents/specification2.html#shioriprotocol">SHIORI/3.0</a>（外部サイト） <a href="http://usada.sakura.vg/contents/shiori.html">SHIORI/2.x</a>（外部サイト）</p>
		</section>
		
		<section class="category" id="capability">
			<h1>実装対応状況の検知</h1>
			<section class="caption">
				<p>拡張ヘッダの実装対応状況については、<a href="./list_shiori_event.html#capability">ID: capability</a>でSHIORI実行の初期に通知される。</p>
			</section>
		</section>
		
		<section class="category" id="request">
			<h1>request</h1>
			<section class="caption">
			<h1>サンプル</h1>
<pre><!--
-->GET SHIORI/3.0
Charset: UTF-8
Sender: SSP
SenderType: internal,raise
SecurityLevel: local
Status: choosing,balloon(0=0)
ID: OnFirstBoot
BaseID: OnBoot
Reference0: 1

</pre>
			<p>※改行コードはCR+LF。
			<br />※最後は空行（前行の終端と合わせて(CR+LF)x2）で終わること。</p>
			</section>
			<dl>
				<dt class="entry">メソッド</dt>
				<dd class="entry">
				<dl class="property">
					<dt>GET</dt>
					<dd>レスポンスのValueヘッダでなにかしらを返すことを前提としているメソッド。</dd>
					<dt>NOTIFY</dt>
					<dd>何も値を返さないことを前提としているメソッド。レスポンスのValueヘッダは無視される。<br>
					主に何かしらのモードの制約で「喋れない」状態の時や、起動直後の状態通知イベントに使用される。<br>
					同じID(イベント名)でGET/NOTIFYの両方とも使われる場合があるので注意。</dd>
				</dl>				</dd>
				
				<dt class="entry">Charset</dt>
				<dd class="entry"><p>文字コード。最初の行、または少なくとも文字コードがASCII範囲以外の行の前が望ましい。</p></dd>
				
				<dt class="entry">Sender</dt>
				<dd class="entry"><p>イベント送信元。</p></dd>
				
				<dt class="entry">SenderType [SSP 2.5.05～拡張]</dt>
				<dd class="entry">
				<p>イベント送信元の属性。下記の通り。複数ある場合はカンマでつなげたもの。<br>
				ID: OnTranslateについては、トランスレート元のイベントの属性を引き継ぐ。</p>
				<dl class="property">
					<dt>internal</dt>
					<dd>アプリケーション内部からのイベント。 </dd>
					<dt>external</dt>
					<dd>アプリケーション外部からのイベント。 </dd>
					<dt>sakuraapi</dt>
					<dd>Sakura APIによって起こされたイベント。 </dd>
					<dt>embed</dt>
					<dd>\![embed]タグによって起こされたイベント。 </dd>
					<dt>raise</dt>
					<dd>\![raise]タグによって起こされたイベント。 </dd>
					<dt>property</dt>
					<dd>プロパティシステムの参照命令の結果起こされたイベント。 </dd>
					<dt>plugin</dt>
					<dd>プラグインによって起こされたイベント。 </dd>
					<dt>sstp</dt>
					<dd>SSTPによって起こされたイベント。 </dd>
					<dt>communicate</dt>
					<dd>コミュニケート仕様によって起こされたイベント。</dd>
				</dl>
				</dd>
				
				<dt class="entry">SecurityLevel</dt>
				<dd class="entry">
				<p>スクリプト実行時のセキュリティレベル。下記のいずれか。
				<br />ID: OnTranslateについては、トランスレート元のイベントの属性を引き継ぐ。
				<br />できるだけ最初のほうの行で通知される。少なくともIDヘッダより前に現れる。</p>
				<dl class="property">
					<dt>local</dt>
					<dd>実行中の端末内からの通知。</dd>
					<dt>external</dt>
					<dd>実行中端末の外部からの通知。</dd>
				</dl>
				<p>externalの場合は実行中マシンの外部からの通知なので、セキュリティ的に取り扱いに注意を要する。<br>
				SenderTypeのinternal/externalとは別の概念であり、アプリケーション外から発生したイベントであっても、安全とみなして良いものはlocal判定となるので、SenderTypeがexternalでもSecurityLevelがlocalとなる場合がある。</p>
				</dd>
				
				<dt class="entry">Status [SSP拡張]</dt>
				<dd class="entry">
				<p>ゴーストの実行状態。下記の通り。複数ある場合はカンマでつなげたもの。</p>
				<dl class="property">
					<dt>talking</dt>
					<dd>喋っている途中 </dd>
					<dt>choosing</dt>
					<dd>選択肢表示中 </dd>
					<dt>minimizing</dt>
					<dd>最小化中 </dd>
					<dt>induction</dt>
					<dd>\![enter,inductionmode]中 </dd>
					<dt>passive</dt>
					<dd>\![enter,passivemode]中 </dd>
					<dt>timecritical</dt>
					<dd>タイムクリティカルセクション(\t)中 </dd>
					<dt>nouserbreak</dt>
					<dd>\![enter,nouserbreak]中 </dd>
					<dt>online</dt>
					<dd>ネットワーク通信中 </dd>
					<dt>opening(種類)</dt>
					<dd>入力ボックス等が開いている。<br>
					複数種類が開いている場合は/区切りで列挙される。<br>
					"dialog"はファイル選択・カラーピッカー等。<br>
					例：opening(communicate/input/teach/dialog)</dd>
					<dt>balloon(ID群)</dt>
					<dd>バルーンが表示状態。<br>
					キャラクターID=バルーンID の形式で列挙される。<br>
					複数開いている場合は/区切りで列挙される。<br>
					例：balloon(0=2/1=0) で、\0が大きいバルーン、\1が通常のバルーンを表示中の意。
					</dd>
				</dl>
				</dd>
				<dt class="entry">ID</dt>
				<dd class="entry"><p>イベント名、またはテキストリソースの識別子。</p></dd>
				
				<dt class="entry">BaseID [SSP拡張]</dt>
				<dd class="entry"><p>互換可能な基本のイベント名。<br>
				例：OnFirstBootはOnBootと互換で、かつOnFirstBootはOnBootの亜種なので、OnFirstBootのBaseIDにはOnBootが入る。</p></dd>
				
				<dt class="entry">Reference*</dt>
				<dd class="entry"><p>イベントに付随する追加情報群。Referenceの後には数字が入る。入れられる行数は制限なし（メモリが許す限り）</p></dd>
				
				<dt class="entry">X-SSTP-PassThru-(任意の文字列) [SSP 2.5.05～拡張]</dt>
				<dd class="entry"><p>SSTPからイベント通知が来た場合に限り、SSTPのリクエストヘッダ内で"X-SSTP-PassThru-"ではじまるものがそのまま通知される。<br>
				SSTP以外の時は追加されない。</p></dd>
			</dl>
		</section>
		<section class="category" id="response">
			<h1>response</h1>
			<section class="caption">
				<h1>サンプル</h1>
<pre><!--
-->SHIORI/3.0 200 OK
Charset: UTF-8
Sender: AYA
Value: \1\s[10]\0\s[0]\e

</pre>
				<p>※改行コードはCR+LF。
				<br />※最後は空行（前行の終端と合わせて(CR+LF)x2）で終わること。</p>
			</section>

			<dl>
				<dt class="entry">ステータスコード</dt>
				<dd class="entry">
				<p>HTTPと同じく、200番台が成功、ほかはなにかしらの失敗（エラー）を示す。<br>
				現在主に使用されているのは下記の通り。</p>
				<dl class="property">
					<dt>200</dt>
					<dd>200 OK<br>成功、返り値(Value)あり。</dd>
					
					<dt>204</dt>
					<dd>204 No Content<br>成功、返り値なし。</dd>
					
					<dt>311</dt>
					<dd>311 Not Enough<br>ID: OnTeach (SHIORI/2系のTEACHメソッド)において、さらなる追加情報を必要とすることを示す。<br>
					入力ボックスを再度開いてユーザーに問い合わせ、入力完了後に入力文字列を含むReferenceを追加する。</dd>
					
					<dt>312</dt>
					<dd>312 Advice<br>ID: OnTeach (SHIORI/2系のTEACHメソッド)において、直近で入力された文字列が解釈不能のため破棄すべきことを示す。<br>
					一番最後のReferenceを破棄し、入力ボックスを再度開いてユーザーに問い合わせ、入力完了後に入力文字列を含むReferenceを追加する。</dd>
					
					<dt>400</dt>
					<dd>400 Bad Request<br>リクエスト文字列が解釈不能だった。</dd>
					
					<dt>500</dt>
					<dd>500 Internal Server Error<br>SHIORI内部でなにかしらのエラーが起き、レスポンスを返せなかった。</dd>
				</dl>
				</dd>
				<dt class="entry">Charset</dt>
				<dd class="entry"><p>文字コード。最初の行、または少なくとも文字コードがASCII範囲以外の行の前が望ましい。</p></dd>
				
				<dt class="entry">Sender</dt>
				<dd class="entry"><p>送り主。通常はSHIORIの名前。</p></dd>
				
				<dt class="entry">Value</dt>
				<dd class="entry"><p>喋りたいスクリプト。</p></dd>
				
				<dt class="entry">ValueNotify [SSP拡張 2.5.35]</dt>
				<dd class="entry"><p><em>[実験的機能]</em>
				<br />リクエストメソッドがNOTIFYの場合でもSakuraScriptを実行するための拡張機能。
				<br />このヘッダでSakuraScriptを返すと、即時実行される。
				<br />実行できるタグは極めて限られ、他のタグやその他文字列は全て無視される。
				<br />メソッドがNOTIFYでない時や、Valueヘッダがすでにある時は無視される。
				<br />現在実行できるタグは以下の通り：</p>
				<ul>
				<li>\![sound]</li>
				<li>\![set,trayicon]</li>
				<li>\![set,trayballoon]</li>
				<li>\![raise] (notifyと同じ動作になる)</li>
				<li>\![raiseother] (notifyと同じ動作になる)</li>
				<li>\![raiseplugin] (notifyと同じ動作になる)</li>
				<li>\![timerraiseother] (notify扱いのイベントになる)</li>
				<li>\![timerraiseplugin] (notify扱いのイベントになる)</li>
				<li>\![notify]</li>
				<li>\![notifyother]</li>
				<li>\![notifyplugin]</li>
				</ul>
				</dd>

				<dt class="entry">SecurityLevel [SSP拡張]</dt>
				<dd class="entry">
				<p>下記のいずれか。</p>
				<dl class="property">
					<dt>local</dt>
					<dd>実行中の端末内からのスクリプト相当のセキュリティレベル。</dd>
					<dt>external</dt>
					<dd>実行中の端末の外部からのスクリプト相当のセキュリティレベル。</dd>
				</dl>
				<p>喋りたいスクリプトのSecurityLevel。externalだと一部のスクリプトがセキュリティ機能により実行不能になる。</p></dd>
				
				<dt class="entry">Marker [SSP拡張]</dt>
				<dd class="entry"><p>バルーンマーカー(バルーン下側の追加情報)に表示したい文字列。</p></dd>
				
				<dt class="entry">ErrorLevel [SSP拡張]</dt>
				<dd class="entry"><p>SHIORI内部で起きたエラーのレベル。下記のいずれか。複数のエラーを表現したい時はバイト値1で区切る。</p>
				<dl class="property">
					<dt>info</dt>
					<dd>情報。エラーではない。</dd>
					<dt>notice</dt>
					<dd>通知。エラーとは言い難いものの修正すべき記述など。</dd>
					<dt>warning</dt>
					<dd>警告。記述ミスなどがあり、処理は停止していないが対処したほうがいいもの。</dd>
					<dt>error</dt>
					<dd>通常のエラー。記述ミスなどで何か処理が停止して再開できない。</dd>
					<dt>critical</dt>
					<dd>致命的エラー。errorより酷く、すぐに何かしら対処をしたほうが良いもの。</dd>
				</dl>				
				<p>このヘッダがある場合は、ユーザーになにかしらのエラーが起きたことが通知される。<br>
				通知されるレベルはユーザーが設定変更可能。通常はerror以上。<br>
				SSPの場合はエラーログに記録され、エラーアイコンが通知領域に出る。</p></dd>
				
				<dt class="entry">ErrorDescription [SSP拡張]</dt>
				<dd class="entry"><p>SHIORI内部で起きたエラーの詳細情報。ErrorLevelがある場合のみ有効。<br>
				複数のエラーを表現したい時はバイト値1で区切る。<br>
				ErrorLevelとErrorDescriptionの要素数は必ず同じでないといけない。</p></dd>
				
				<dt class="entry">BalloonOffset [SSP拡張]</dt>
				<dd class="entry"><p>バルーンのオフセット値(X,Y)。</p></dd>
				
				<dt class="entry">Reference0</dt>
				<dd class="entry"><p>コミュニケートを送りたい場合、ゴーストの\0側の名前。</p></dd>
				
				<dt class="entry">Reference1～</dt>
				<dd class="entry"><p>コミュニケートの追加情報。<br>
				レスポンスのReference1＝SSTP CommunicateのReference0＝受け手のOnCommunicateのReference2<br>
				互換性の問題で以上のようにずれてしまうことに注意。</p></dd>
				
				<dt class="entry">Age [SSP拡張]</dt>
				<dd class="entry"><p>コミュニケートの世代数。初回はゼロ。やりとりを重ねるたびに+1。<br>
				SSP拡張だが、実質はSHIORI/2.x互換処理。</p></dd>
				
				<dt class="entry">MarkerSend [SSP拡張]</dt>
				<dd class="entry"><p>コミュニケート中に「相手側に」表示したいバルーンマーカー文字列。<br>
				SSTPのMarkerヘッダとして送信される。</p></dd>
				
				<dt class="entry">X-SSTP-PassThru-(任意の文字列) [SSP 2.5.03～拡張]</dt>
				<dd class="entry"><p>SSTPからイベント通知が来た場合のレスポンスに限り、このヘッダがSSTPのレスポンスにそのまま追加される。<br>
				SSTP以外の時は無視される。<br>
				複数のヘッダを指定可能だが、複数返したい場合はヘッダ名を変えること。<br>
				（旧ヘッダ名：X-SSTP-Return- は廃止予定）</p></dd>
			</dl>
		</section>
	</div>
</body>
</html>